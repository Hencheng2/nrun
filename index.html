<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mini IDE - HTML/CSS/JS/Python</title>
<link rel="stylesheet" data-name="vs/editor/editor.main" href="https://cdn.jsdelivr.net/npm/monaco-editor@0.43.0/min/vs/editor/editor.main.css">
<style>
    body { margin:0; font-family: 'Segoe UI', sans-serif; background-color: #1e1e1e; color: #c9d1d9; }
    #controls { padding: 10px; background: #111; border-bottom: 1px solid #333; display: flex; gap:10px; align-items:center; flex-wrap: wrap; }
    button, input { background:#333; color:#c9d1d9; border:none; padding:5px 10px; cursor:pointer; border-radius:4px;}
    button:hover, input:hover { background:#555; }
    #main { display:flex; height:calc(100vh - 50px); }
    #editor { width:50%; border-right:1px solid #333; }
    #fileList { list-style:none; padding:0; margin:0; max-height:150px; overflow-y:auto; }
    #fileList li { padding:3px; cursor:pointer; border-bottom:1px solid #222; display:flex; justify-content: space-between; }
    #fileList li span { flex-grow:1; }
    #fileList li button { background:#900; color:#fff; padding:0 5px; border-radius:3px; font-size:12px; }
    #fileList li button:hover { background:#f00; }
    #sidePanel { width:50%; display:flex; flex-direction:column; }
    #console, #bashConsole { background: #111; color:#0f0; padding:5px; overflow-y:auto; font-family: monospace; flex:1; margin:2px; border-radius:4px; }
    #bashInput { width:100%; padding:5px; border:none; border-radius:4px; background:#111; color:#c9d1d9; font-family: monospace; }
    #outputIframe { flex:1; margin:2px; border:none; background:#fff; }
</style>
</head>
<body>
<div id="controls">
    <button onclick="newFile('html')">New HTML</button>
    <button onclick="newFile('css')">New CSS</button>
    <button onclick="newFile('js')">New JS</button>
    <button onclick="newFile('py')">New Python</button>
    <button onclick="newFile('requirements')">New requirements.txt</button>
    <button onclick="runCode()">Run</button>
    <input type="file" id="uploadFile" onchange="uploadFile(event)">
</div>
<div id="main">
    <div id="editor"></div>
    <div id="sidePanel">
        <ul id="fileList"></ul>
        <iframe id="outputIframe"></iframe>
        <div id="console"></div>
        <div id="bashConsole"></div>
        <input id="bashInput" placeholder="Python Bash Input (Enter to run)">
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.43.0/min/vs/loader.js"></script>
<script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
<script>
let editor;
let pyodide;
let currentFile = null;
let projectFiles = {};

const templates = {
    html: "<!DOCTYPE html>\n<html>\n<head>\n<title>New Page</title>\n</head>\n<body>\n\n</body>\n</html>",
    css: "/* CSS Starter */\nbody {\n    background-color: #1e1e1e;\n    color: #c9d1d9;\n}",
    js: "// JS Starter\nconsole.log('Hello World');",
    py: "# Python Starter\nprint('Hello World')",
    requirements: "# Enter Python packages, one per line\n"
};

// Initialize Monaco Editor
require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.43.0/min/vs' }});
require(['vs/editor/editor.main'], function () {
    editor = monaco.editor.create(document.getElementById('editor'), {
        value: '',
        language: 'javascript',
        theme: 'vs-dark',
        automaticLayout: true,
        fontSize: 14,
        minimap: {enabled: false}
    });
    loadProjectFromStorage();
});

// Load Pyodide
async function loadPyodideAndPackages(){
    if(!pyodide) pyodide = await loadPyodide({indexURL: "https://cdn.jsdelivr.net/pyodide/v0.25.0/full/"});
    return pyodide;
}

// New File
async function newFile(type){
    const name = prompt("Enter file name:") || `file${Object.keys(projectFiles).length+1}.${type==='requirements'?'txt':type}`;
    projectFiles[name] = {content: templates[type], type};
    currentFile = name;
    editor.setValue(projectFiles[name].content);
    const langMap = {py:'python', js:'javascript', html:'html', css:'css', requirements:'text'};
    monaco.editor.setModelLanguage(editor.getModel(), langMap[type]);
    refreshFileList();
    saveProjectToStorage();
}

// Refresh File List
function refreshFileList(){
    const list = document.getElementById('fileList');
    list.innerHTML = '';
    for(let f in projectFiles){
        const li = document.createElement('li');
        const span = document.createElement('span');
        span.textContent = f;
        span.onclick = ()=>openFile(f);
        const delBtn = document.createElement('button');
        delBtn.textContent = 'X';
        delBtn.onclick = (e)=>{e.stopPropagation(); deleteFile(f);}
        li.appendChild(span);
        li.appendChild(delBtn);
        list.appendChild(li);
    }
}

// Delete File
function deleteFile(name){
    if(confirm(`Delete ${name}?`)){
        delete projectFiles[name];
        if(currentFile===name) currentFile = null;
        refreshFileList();
        saveProjectToStorage();
    }
}

// Open File
function openFile(name){
    currentFile = name;
    editor.setValue(projectFiles[name].content);
    const langMap = {py:'python', js:'javascript', html:'html', css:'css', requirements:'text'};
    monaco.editor.setModelLanguage(editor.getModel(), langMap[projectFiles[name].type]);
}

// Upload File
async function uploadFile(event){
    const file = event.target.files[0];
    const reader = new FileReader();
    reader.onload = async e=>{
        const ext = file.name.split('.').pop();
        const type = file.name==='requirements.txt' ? 'requirements' : ext;
        projectFiles[file.name] = {content:e.target.result, type};
        if(type==='requirements') await installRequirements(e.target.result);
        openFile(file.name);
        refreshFileList();
        saveProjectToStorage();
    };
    reader.readAsText(file);
}

// Install Requirements
async function installRequirements(content){
    await loadPyodideAndPackages();
    await pyodide.loadPackage('micropip');
    const packages = content.split('\n').map(l=>l.trim()).filter(l=>l && !l.startsWith('#'));
    for(const pkg of packages){
        try{
            await pyodide.runPythonAsync(`import micropip; await micropip.install('${pkg}')`);
            console.log(`Installed: ${pkg}`);
        } catch(err){
            console.error(`Failed to install ${pkg}:`, err);
        }
    }
    alert('Requirements installed!');
}

// Run Code
async function runCode(){
    if(!currentFile) return;
    const file = projectFiles[currentFile];
    const type = file.type;
    const content = editor.getValue();
    projectFiles[currentFile].content = content;
    saveProjectToStorage();

    const consoleDiv = document.getElementById('console');
    consoleDiv.innerHTML = '';
    const outputIframe = document.getElementById('outputIframe');
    outputIframe.srcdoc = '';

    if(type==='py'){
        try{
            await loadPyodideAndPackages();
            await pyodide.loadPackagesFromImports(content);
            let output = await pyodide.runPythonAsync(content);
            consoleDiv.innerText = output!==undefined?output:'Python code executed';
        }catch(e){
            consoleDiv.innerText = e;
        }
    } else if(type==='html' || type==='css' || type==='js'){
        let html = '';
        if(type==='html') html += content;
        for(let f in projectFiles){
            if(projectFiles[f].type==='css') html += `<style>${projectFiles[f].content}</style>`;
            if(projectFiles[f].type==='js') html += `<script>${projectFiles[f].content}<\/script>`;
        }
        outputIframe.srcdoc = html;
    }
}

// Python Bash Console
document.getElementById('bashInput').addEventListener('keydown', async function(e){
    if(e.key==='Enter'){
        const cmd = this.value;
        const bashDiv = document.getElementById('bashConsole');
        bashDiv.innerHTML += `>>> ${cmd}\n`;
        this.value = '';
        try{
            await loadPyodideAndPackages();
            let result = await pyodide.runPythonAsync(cmd);
            if(result!==undefined) bashDiv.innerHTML += `${result}\n`;
        }catch(err){
            bashDiv.innerHTML += `${err}\n`;
        }
        bashDiv.scrollTop = bashDiv.scrollHeight;
    }
});

// Save project to localStorage
function saveProjectToStorage(){
    localStorage.setItem('miniIDEProject', JSON.stringify(projectFiles));
}

// Load project from localStorage
function loadProjectFromStorage(){
    const stored = localStorage.getItem('miniIDEProject');
    if(stored){
        projectFiles = JSON.parse(stored);
        const files = Object.keys(projectFiles);
        if(files.length) currentFile = files[0];
        refreshFileList();
        if(currentFile) openFile(currentFile);
    }
}
</script>
</body>
</html>
