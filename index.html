<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeRunner IDE</title>
    <!-- Monaco Editor -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs/loader.js"></script>
    <!-- Pyodide -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
    <style>
        :root {
            --bg-primary: #1e1e1e;
            --bg-secondary: #252526;
            --bg-tertiary: #2d2d30;
            --accent-primary: #007acc;
            --accent-secondary: #3c3c3c;
            --text-primary: #d4d4d4;
            --text-secondary: #9e9e9e;
            --success: #4ec9b0;
            --error: #f44747;
            --warning: #d7ba7d;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: grid;
            grid-template-rows: 50px 1fr 30%;
            height: 100vh;
        }

        header {
            background-color: var(--bg-secondary);
            display: flex;
            align-items: center;
            padding: 0 20px;
            border-bottom: 1px solid var(--accent-secondary);
        }

        .logo {
            font-weight: bold;
            color: var(--accent-primary);
            margin-right: 20px;
        }

        .toolbar {
            display: flex;
            gap: 10px;
        }

        button {
            background-color: var(--accent-secondary);
            color: var(--text-primary);
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        button:hover {
            background-color: var(--accent-primary);
        }

        select {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--accent-secondary);
            padding: 6px;
            border-radius: 4px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 200px 1fr;
        }

        .sidebar {
            background-color: var(--bg-secondary);
            padding: 15px;
            overflow-y: auto;
            border-right: 1px solid var(--accent-secondary);
        }

        .file-tree {
            list-style: none;
        }

        .file-item {
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 4px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
        }

        .file-item:hover {
            background-color: var(--accent-secondary);
        }

        .file-item.active {
            background-color: var(--accent-primary);
        }

        .file-icon {
            margin-right: 8px;
            width: 16px;
            text-align: center;
        }

        .editor-container {
            display: flex;
            flex-direction: column;
        }

        #editor {
            flex: 1;
        }

        .output-container {
            background-color: var(--bg-secondary);
            border-top: 1px solid var(--accent-secondary);
            display: flex;
            flex-direction: column;
        }

        .output-tabs {
            display: flex;
            background-color: var(--bg-tertiary);
        }

        .output-tab {
            padding: 8px 16px;
            cursor: pointer;
            border-right: 1px solid var(--accent-secondary);
        }

        .output-tab.active {
            background-color: var(--accent-primary);
        }

        .output-content {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
        }

        #console-output {
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 14px;
        }

        #html-output {
            width: 100%;
            height: 100%;
            border: none;
            background-color: white;
        }

        .hidden {
            display: none;
        }

        .status-bar {
            background-color: var(--accent-primary);
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 12px;
        }

        #upload-btn {
            position: relative;
            overflow: hidden;
        }

        #file-upload {
            position: absolute;
            top: 0;
            left: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 4px;
            background-color: var(--success);
            color: white;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .toast.show {
            opacity: 1;
        }

        .toast.error {
            background-color: var(--error);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">CodeRunner IDE</div>
            <div class="toolbar">
                <button id="new-btn">New File</button>
                <button id="save-btn">Save</button>
                <button id="run-btn">Run</button>
                <button id="upload-btn">
                    Upload
                    <input type="file" id="file-upload" multiple>
                </button>
                <select id="language-select">
                    <option value="html">HTML</option>
                    <option value="css">CSS</option>
                    <option value="js">JavaScript</option>
                    <option value="python">Python</option>
                </select>
            </div>
        </header>

        <div class="main-content">
            <div class="sidebar">
                <h3>Project Files</h3>
                <ul class="file-tree" id="file-tree">
                    <!-- Files will be listed here -->
                </ul>
            </div>
            <div class="editor-container">
                <div id="editor" style="height: 100%;"></div>
            </div>
        </div>

        <div class="output-container">
            <div class="output-tabs">
                <div class="output-tab active" data-tab="console">Console</div>
                <div class="output-tab" data-tab="output">Output</div>
            </div>
            <div class="output-content">
                <div id="console-output"></div>
                <iframe id="html-output" class="hidden"></iframe>
            </div>
        </div>

        <div class="status-bar">
            <div id="status-text">Ready</div>
            <div id="file-type">No file selected</div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // Initialize Pyodide
        let pyodide;
        async function loadPyodide() {
            document.getElementById('status-text').textContent = 'Loading Pyodide...';
            pyodide = await loadPyodide();
            document.getElementById('status-text').textContent = 'Pyodide loaded';
            console.log('Pyodide loaded');
        }
        loadPyodide();

        // Monaco Editor initialization
        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs' }});
        let editor;
        require(['vs/editor/editor.main'], function() {
            editor = monaco.editor.create(document.getElementById('editor'), {
                value: '',
                language: 'html',
                theme: 'vs-dark',
                automaticLayout: true,
                minimap: { enabled: false }
            });
        });

        // Project state
        let project = {
            files: [],
            currentFile: null
        };

        // Starter templates
        const templates = {
            html: `<!DOCTYPE html>
<html>
<head>
    <title>Page Title</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 40px;
            background-color: #1e1e1e;
            color: #d4d4d4;
        }
    </style>
</head>
<body>
    <h1>Hello World</h1>
    <p>This is a starter HTML template.</p>
    <script>
        console.log('Hello from JavaScript!');
    </script>
</body>
</html>`,
            css: `body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 20px;
    background-color: #1e1e1e;
    color: #d4d4d4;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
}`,
            js: `// JavaScript code
console.log('Hello from JavaScript!');

function greet(name) {
    return 'Hello, ' + name + '!';
}

// Example usage
const message = greet('World');
console.log(message);`,
            python: `# Python code
print("Hello from Python!")

def greet(name):
    return f"Hello, {name}!"

# Example usage
message = greet("World")
print(message)`
        };

        // DOM elements
        const fileTree = document.getElementById('file-tree');
        const languageSelect = document.getElementById('language-select');
        const newBtn = document.getElementById('new-btn');
        const saveBtn = document.getElementById('save-btn');
        const runBtn = document.getElementById('run-btn');
        const fileUpload = document.getElementById('file-upload');
        const consoleOutput = document.getElementById('console-output');
        const htmlOutput = document.getElementById('html-output');
        const outputTabs = document.querySelectorAll('.output-tab');
        const statusText = document.getElementById('status-text');
        const fileType = document.getElementById('file-type');
        const toast = document.getElementById('toast');

        // Event listeners
        newBtn.addEventListener('click', createNewFile);
        saveBtn.addEventListener('click', saveFile);
        runBtn.addEventListener('click', runCode);
        fileUpload.addEventListener('change', handleFileUpload);
        languageSelect.addEventListener('change', updateEditorLanguage);

        outputTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // Remove active class from all tabs
                outputTabs.forEach(t => t.classList.remove('active'));
                // Add active class to clicked tab
                tab.classList.add('active');
                
                // Show appropriate output
                if (tab.dataset.tab === 'console') {
                    consoleOutput.classList.remove('hidden');
                    htmlOutput.classList.add('hidden');
                } else {
                    consoleOutput.classList.add('hidden');
                    htmlOutput.classList.remove('hidden');
                }
            });
        });

        // Functions
        function createNewFile() {
            const language = languageSelect.value;
            const fileName = prompt('Enter file name:');
            if (!fileName) return;
            
            const fullFileName = fileName.includes('.') ? fileName : `${fileName}.${language}`;
            const fileType = fullFileName.split('.').pop();
            
            // Check if file already exists
            if (project.files.some(file => file.name === fullFileName)) {
                showToast('File already exists!', true);
                return;
            }
            
            const newFile = {
                name: fullFileName,
                type: fileType,
                content: templates[fileType] || ''
            };
            
            project.files.push(newFile);
            renderFileTree();
            openFile(newFile);
            showToast(`Created ${fullFileName}`);
        }

        function saveFile() {
            if (!project.currentFile) {
                showToast('No file selected!', true);
                return;
            }
            
            const content = editor.getValue();
            project.currentFile.content = content;
            localStorage.setItem('coderunner-project', JSON.stringify(project));
            showToast('File saved');
        }

        async function runCode() {
            if (!project.currentFile) {
                showToast('No file selected!', true);
                return;
            }
            
            // Save current content
            project.currentFile.content = editor.getValue();
            
            // Clear console
            consoleOutput.textContent = '';
            
            // Show console tab
            outputTabs[0].click();
            
            // Run based on file type
            switch (project.currentFile.type) {
                case 'html':
                    runHtml();
                    break;
                case 'css':
                    showToast('CSS files need to be linked from an HTML file', true);
                    break;
                case 'js':
                    runJs();
                    break;
                case 'py':
                case 'python':
                    await runPython();
                    break;
                default:
                    showToast(`Cannot run ${project.currentFile.type} files`, true);
            }
        }

        function runHtml() {
            const htmlContent = project.currentFile.content;
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            htmlOutput.src = url;
            
            // Switch to output tab after a short delay
            setTimeout(() => outputTabs[1].click(), 300);
        }

        function runJs() {
            try {
                // Capture console.log output
                const originalConsoleLog = console.log;
                console.log = function(...args) {
                    originalConsoleLog.apply(console, args);
                    consoleOutput.textContent += args.join(' ') + '\n';
                };
                
                // Execute the JavaScript code
                eval(project.currentFile.content);
                
                // Restore console.log
                console.log = originalConsoleLog;
            } catch (error) {
                consoleOutput.textContent += `Error: ${error.message}\n`;
            }
        }

        async function runPython() {
            if (!pyodide) {
                consoleOutput.textContent = 'Pyodide not loaded yet. Please wait...\n';
                return;
            }
            
            statusText.textContent = 'Running Python...';
            
            try {
                // Capture print statements
                pyodide.runPython(`
                    import sys
                    from js import consoleOutput
                    class OutputStream:
                        def write(self, text):
                            consoleOutput.textContent += text
                    sys.stdout = OutputStream()
                    sys.stderr = OutputStream()
                `);
                
                // Run the Python code
                await pyodide.runPythonAsync(project.currentFile.content);
                statusText.textContent = 'Python executed successfully';
            } catch (error) {
                consoleOutput.textContent += `Error: ${error.message}\n`;
                statusText.textContent = 'Python execution failed';
            }
        }

        function handleFileUpload(event) {
            const files = event.target.files;
            if (!files.length) return;
            
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const content = e.target.result;
                    const fileType = file.name.split('.').pop();
                    
                    const newFile = {
                        name: file.name,
                        type: fileType,
                        content: content
                    };
                    
                    // Check if file already exists
                    const existingIndex = project.files.findIndex(f => f.name === file.name);
                    if (existingIndex !== -1) {
                        project.files[existingIndex] = newFile;
                    } else {
                        project.files.push(newFile);
                    }
                    
                    renderFileTree();
                    openFile(newFile);
                    showToast(`Uploaded ${file.name}`);
                };
                reader.readAsText(file);
            });
            
            // Reset the file input
            event.target.value = '';
        }

        function updateEditorLanguage() {
            if (!editor) return;
            
            const language = languageSelect.value;
            const model = editor.getModel();
            
            let monacoLanguage;
            switch (language) {
                case 'html': monacoLanguage = 'html'; break;
                case 'css': monacoLanguage = 'css'; break;
                case 'js': monacoLanguage = 'javascript'; break;
                case 'python': monacoLanguage = 'python'; break;
                default: monacoLanguage = 'plaintext';
            }
            
            monaco.editor.setModelLanguage(model, monacoLanguage);
        }

        function renderFileTree() {
            fileTree.innerHTML = '';
            
            project.files.forEach(file => {
                const li = document.createElement('li');
                li.className = 'file-item';
                if (project.currentFile && project.currentFile.name === file.name) {
                    li.classList.add('active');
                }
                
                li.innerHTML = `
                    <span class="file-icon">${getFileIcon(file.type)}</span>
                    <span class="file-name">${file.name}</span>
                `;
                
                li.addEventListener('click', () => openFile(file));
                fileTree.appendChild(li);
            });
        }

        function getFileIcon(type) {
            switch (type) {
                case 'html': return '🌐';
                case 'css': return '🎨';
                case 'js': return '📜';
                case 'py': case 'python': return '🐍';
                default: return '📄';
            }
        }

        function openFile(file) {
            project.currentFile = file;
            editor.setValue(file.content);
            
            // Update language select based on file type
            languageSelect.value = file.type;
            updateEditorLanguage();
            
            // Update file type in status bar
            fileType.textContent = `${file.name} (${file.type})`;
            
            renderFileTree();
        }

        function showToast(message, isError = false) {
            toast.textContent = message;
            toast.className = isError ? 'toast error' : 'toast';
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Load project from localStorage if available
        window.addEventListener('load', () => {
            const savedProject = localStorage.getItem('coderunner-project');
            if (savedProject) {
                project = JSON.parse(savedProject);
                renderFileTree();
                
                if (project.files.length > 0) {
                    openFile(project.files[0]);
                }
            }
            
            statusText.textContent = 'Ready';
        });
    </script>
</body>
</html>
