<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern Web IDE</title>
    <!-- Monaco Editor -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.js"></script>
    <!-- JSZip for export/import -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- FileSaver for export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- Pyodide for Python execution -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
    <style>
        :root {
            --bg-primary: #1e1e1e;
            --bg-secondary: #252526;
            --bg-tertiary: #2d2d30;
            --text-primary: #cccccc;
            --text-secondary: #969696;
            --accent-blue: #007acc;
            --accent-green: #4ec9b0;
            --accent-orange: #ce9178;
            --accent-purple: #c586c0;
            --border-color: #3e3e42;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background-color: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 15px;
            font-weight: bold;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-tree {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }

        .file-item {
            padding: 5px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .file-item:hover {
            background-color: var(--bg-tertiary);
        }

        .file-item.active {
            background-color: var(--accent-blue);
            color: white;
        }

        .file-actions {
            padding: 10px 15px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            border-top: 1px solid var(--border-color);
        }

        .btn {
            background-color: var(--accent-blue);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 3px;
            cursor: pointer;
            text-align: center;
            font-size: 13px;
        }

        .btn:hover {
            opacity: 0.9;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .editor-container {
            flex: 1;
            position: relative;
        }

        #editor {
            width: 100%;
            height: 100%;
        }

        /* Right Panel */
        .right-panel {
            width: 50%;
            display: flex;
            flex-direction: column;
            border-left: 1px solid var(--border-color);
        }

        .panel {
            position: relative;
            overflow: hidden;
        }

        .preview-panel {
            flex: 1;
            border-bottom: 1px solid var(--border-color);
        }

        .console-panel {
            height: 30%;
        }

        .panel-header {
            padding: 8px 15px;
            background-color: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-content {
            height: calc(100% - 36px);
            overflow: auto;
        }

        #preview {
            width: 100%;
            height: 100%;
            border: none;
            background-color: white;
        }

        #console {
            padding: 10px;
            font-family: monospace;
            white-space: pre-wrap;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            height: 100%;
            overflow: auto;
        }

        /* Resizable panels */
        .resizer {
            background-color: var(--border-color);
            cursor: col-resize;
            width: 5px;
        }

        .resizer-horizontal {
            background-color: var(--border-color);
            cursor: row-resize;
            height: 5px;
        }

        /* Top bar */
        .top-bar {
            padding: 10px 15px;
            background-color: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .run-btn {
            background-color: var(--accent-green);
            color: black;
            font-weight: bold;
        }

        /* File icons */
        .file-icon {
            width: 16px;
            height: 16px;
            display: inline-block;
            margin-right: 5px;
            background-size: contain;
            background-repeat: no-repeat;
        }

        .html-file { background-color: #e44d26; }
        .css-file { background-color: #264de4; }
        .js-file { background-color: #f7df1e; }
        .py-file { background-color: #3776ab; }
        .txt-file { background-color: #888; }
        .json-file { background-color: #f5de19; color: #000; text-align: center; font-weight: bold; }
        .folder-icon { background-color: #7ebae4; }

        /* Hidden file input */
        #fileInput {
            display: none;
        }

        /* Context menu */
        .context-menu {
            position: absolute;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .context-menu-item {
            padding: 8px 12px;
            cursor: pointer;
        }

        .context-menu-item:hover {
            background-color: var(--accent-blue);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <span>EXPLORER</span>
            </div>
            <div class="file-tree" id="fileTree">
                <!-- Files will be populated here -->
            </div>
            <div class="file-actions">
                <button class="btn" id="newFileBtn">New File</button>
                <button class="btn" id="uploadFileBtn">Upload File</button>
                <input type="file" id="fileInput" multiple>
            </div>
        </div>

        <div class="resizer" id="sidebarResizer"></div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="top-bar">
                <div>
                    <button class="btn run-btn" id="runBtn">Run</button>
                </div>
                <div>
                    <button class="btn" id="exportBtn">Export Project</button>
                    <button class="btn" id="importBtn">Import Project</button>
                </div>
            </div>
            <div class="editor-container">
                <div id="editor"></div>
            </div>
        </div>

        <div class="resizer" id="mainResizer"></div>

        <!-- Right Panel -->
        <div class="right-panel">
            <div class="panel preview-panel">
                <div class="panel-header">
                    <span>Preview</span>
                </div>
                <div class="panel-content">
                    <iframe id="preview"></iframe>
                </div>
            </div>
            <div class="resizer-horizontal" id="previewResizer"></div>
            <div class="panel console-panel">
                <div class="panel-header">
                    <span>Console</span>
                    <button class="btn" id="clearConsoleBtn">Clear</button>
                </div>
                <div class="panel-content">
                    <pre id="console"></pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        const state = {
            files: {},
            currentFile: null,
            pyodide: null,
            isPyodideLoading: false,
            editor: null
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', async function() {
            await initializeMonaco();
            initializeResizers();
            loadFromLocalStorage();
            setupEventListeners();
            initializePyodide();
            updateFileTree();
            
            // Create default files if none exist
            if (Object.keys(state.files).length === 0) {
                createFile('index.html', 'html', '<!DOCTYPE html>\n<html>\n<head>\n    <title>Hello World</title>\n</head>\n<body>\n    <h1>Hello World!</h1>\n</body>\n</html>');
                createFile('style.css', 'css', 'body { font-family: Arial, sans-serif; margin: 40px; background: #f0f0f0; }');
                createFile('script.js', 'js', 'console.log("Hello from JavaScript!");');
                createFile('main.py', 'python', 'print("Hello from Python!")');
                switchToFile('index.html');
            }
        });

        // Initialize Monaco Editor
        async function initializeMonaco() {
            return new Promise((resolve) => {
                require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' } });
                require(['vs/editor/editor.main'], function() {
                    state.editor = monaco.editor.create(document.getElementById('editor'), {
                        value: '',
                        language: 'plaintext',
                        theme: 'vs-dark',
                        automaticLayout: true,
                        minimap: { enabled: false }
                    });
                    
                    // Add change listener for autosave
                    state.editor.onDidChangeModelContent(() => {
                        if (state.currentFile) {
                            state.files[state.currentFile].content = state.editor.getValue();
                            saveToLocalStorage();
                            updatePreview();
                        }
                    });
                    
                    resolve();
                });
            });
        }

        // Set up event listeners
        function setupEventListeners() {
            document.getElementById('newFileBtn').addEventListener('click', promptNewFile);
            document.getElementById('uploadFileBtn').addEventListener('click', () => document.getElementById('fileInput').click());
            document.getElementById('fileInput').addEventListener('change', handleFileUpload);
            document.getElementById('runBtn').addEventListener('click', runProject);
            document.getElementById('exportBtn').addEventListener('click', exportProject);
            document.getElementById('importBtn').addEventListener('click', () => document.getElementById('fileInput').click());
            document.getElementById('clearConsoleBtn').addEventListener('click', () => document.getElementById('console').textContent = '');
            
            // Context menu for files
            document.getElementById('fileTree').addEventListener('contextmenu', handleContextMenu);
            document.addEventListener('click', () => {
                const contextMenu = document.querySelector('.context-menu');
                if (contextMenu) contextMenu.remove();
            });
        }

        // Initialize Pyodide
        async function initializePyodide() {
            state.isPyodideLoading = true;
            logToConsole('Loading Pyodide...');
            
            try {
                state.pyodide = await loadPyodide();
                logToConsole('Pyodide loaded successfully.');
            } catch (error) {
                logToConsole('Error loading Pyodide: ' + error.message);
            }
            
            state.isPyodideLoading = false;
        }

        // Create a new file
        function createFile(name, type, content = '') {
            // Ensure unique filename
            let filename = name;
            let counter = 1;
            while (state.files[filename]) {
                const dotIndex = name.lastIndexOf('.');
                if (dotIndex === -1) {
                    filename = `${name} (${counter})`;
                } else {
                    const base = name.substring(0, dotIndex);
                    const ext = name.substring(dotIndex);
                    filename = `${base} (${counter})${ext}`;
                }
                counter++;
            }
            
            state.files[filename] = {
                content: content,
                type: type
            };
            
            saveToLocalStorage();
            updateFileTree();
            return filename;
        }

        // Prompt user for new file name
        function promptNewFile() {
            const name = prompt('Enter file name (with extension):');
            if (!name) return;
            
            const extension = name.split('.').pop().toLowerCase();
            let type = 'plaintext';
            
            if (extension === 'html') type = 'html';
            else if (extension === 'css') type = 'css';
            else if (extension === 'js') type = 'javascript';
            else if (extension === 'py') type = 'python';
            else if (extension === 'json') type = 'json';
            
            const filename = createFile(name, type);
            switchToFile(filename);
        }

        // Handle file upload
        function handleFileUpload(event) {
            const files = event.target.files;
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const extension = file.name.split('.').pop().toLowerCase();
                    let type = 'plaintext';
                    
                    if (extension === 'html') type = 'html';
                    else if (extension === 'css') type = 'css';
                    else if (extension === 'js') type = 'javascript';
                    else if (extension === 'py') type = 'python';
                    else if (extension === 'json') type = 'json';
                    
                    createFile(file.name, type, e.target.result);
                };
                
                reader.readAsText(file);
            }
            
            // Reset the input
            event.target.value = '';
        }

        // Switch to a file
        function switchToFile(filename) {
            if (!state.files[filename]) return;
            
            state.currentFile = filename;
            const file = state.files[filename];
            
            // Update editor
            state.editor.setValue(file.content);
            monaco.editor.setModelLanguage(state.editor.getModel(), file.type);
            
            // Update file tree
            updateFileTree();
        }

        // Delete a file
        function deleteFile(filename) {
            if (!confirm(`Are you sure you want to delete ${filename}?`)) return;
            
            delete state.files[filename];
            
            if (state.currentFile === filename) {
                const remainingFiles = Object.keys(state.files);
                if (remainingFiles.length > 0) {
                    switchToFile(remainingFiles[0]);
                } else {
                    state.currentFile = null;
                    state.editor.setValue('');
                }
            }
            
            saveToLocalStorage();
            updateFileTree();
        }

        // Update file tree display
        function updateFileTree() {
            const fileTree = document.getElementById('fileTree');
            fileTree.innerHTML = '';
            
            Object.keys(state.files).sort().forEach(filename => {
                const file = state.files[filename];
                const fileItem = document.createElement('div');
                fileItem.className = `file-item ${state.currentFile === filename ? 'active' : ''}`;
                
                const icon = document.createElement('span');
                icon.className = 'file-icon';
                
                if (file.type === 'html') icon.classList.add('html-file');
                else if (file.type === 'css') icon.classList.add('css-file');
                else if (file.type === 'javascript') icon.classList.add('js-file');
                else if (file.type === 'python') icon.classList.add('py-file');
                else if (file.type === 'json') icon.classList.add('json-file');
                else icon.classList.add('txt-file');
                
                const name = document.createTextNode(filename);
                
                fileItem.appendChild(icon);
                fileItem.appendChild(name);
                
                fileItem.addEventListener('click', () => switchToFile(filename));
                
                fileTree.appendChild(fileItem);
            });
        }

        // Handle context menu for files
        function handleContextMenu(event) {
            const fileItem = event.target.closest('.file-item');
            if (!fileItem) return;
            
            event.preventDefault();
            
            // Remove any existing context menu
            const existingMenu = document.querySelector('.context-menu');
            if (existingMenu) existingMenu.remove();
            
            const filename = fileItem.textContent;
            
            const contextMenu = document.createElement('div');
            contextMenu.className = 'context-menu';
            contextMenu.style.top = `${event.pageY}px`;
            contextMenu.style.left = `${event.pageX}px`;
            
            const deleteOption = document.createElement('div');
            deleteOption.className = 'context-menu-item';
            deleteOption.textContent = 'Delete';
            deleteOption.addEventListener('click', () => deleteFile(filename));
            
            contextMenu.appendChild(deleteOption);
            document.body.appendChild(contextMenu);
        }

        // Run the project
        async function runProject() {
            // Clear console
            document.getElementById('console').textContent = '';
            
            // Update preview
            updatePreview();
            
            // Run Python files if Pyodide is loaded
            if (state.pyodide && !state.isPyodideLoading) {
                await runPythonFiles();
            } else if (!state.pyodide && !state.isPyodideLoading) {
                await initializePyodide();
                if (state.pyodide) await runPythonFiles();
            }
        }

        // Update the preview iframe
        function updatePreview() {
            const preview = document.getElementById('preview');
            let html = '', css = '', js = '';
            
            // Gather HTML, CSS, and JS files
            Object.keys(state.files).forEach(filename => {
                const file = state.files[filename];
                if (file.type === 'html') html += file.content;
                else if (file.type === 'css') css += file.content;
                else if (file.type === 'javascript') js += file.content;
            });
            
            // Create a complete HTML document
            const fullHtml = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <style>${css}</style>
                </head>
                <body>
                    ${html}
                    <script>${js}<\/script>
                </body>
                </html>
            `;
            
            // Update the iframe
            preview.contentDocument?.write(fullHtml);
            preview.contentDocument?.close();
        }

        // Run Python files
        async function runPythonFiles() {
            let pythonCode = '';
            let hasRequirements = false;
            
            // Gather Python code and check for requirements.txt
            Object.keys(state.files).forEach(filename => {
                const file = state.files[filename];
                if (file.type === 'python') {
                    if (filename === 'requirements.txt') {
                        hasRequirements = true;
                    } else {
                        pythonCode += `# ${filename}\n${file.content}\n\n`;
                    }
                }
            });
            
            if (!pythonCode && !hasRequirements) return;
            
            logToConsole('Running Python code...');
            
            try {
                // Install requirements if needed
                if (hasRequirements && state.files['requirements.txt']) {
                    const requirements = state.files['requirements.txt'].content.split('\n');
                    for (const requirement of requirements) {
                        const packageName = requirement.trim();
                        if (!packageName || packageName.startsWith('#')) continue;
                        
                        logToConsole(`Installing ${packageName}...`);
                        try {
                            await state.pyodide.loadPackage(['micropip']);
                            const micropip = state.pyodide.pyimport('micropip');
                            await micropip.install(packageName);
                            logToConsole(`✓ Installed ${packageName}`);
                        } catch (error) {
                            logToConsole(`✗ Failed to install ${packageName}: ${error.message}`);
                        }
                    }
                }
                
                // Run the Python code
                if (pythonCode) {
                    const result = await state.pyodide.runPythonAsync(pythonCode);
                    if (result !== undefined) {
                        logToConsole(result.toString());
                    }
                    logToConsole('Python execution completed.');
                }
            } catch (error) {
                logToConsole('Python error: ' + error.message);
            }
        }

        // Log to console
        function logToConsole(message) {
            const consoleElem = document.getElementById('console');
            consoleElem.textContent += message + '\n';
            consoleElem.scrollTop = consoleElem.scrollHeight;
        }

        // Export project as ZIP
        async function exportProject() {
            const zip = new JSZip();
            
            Object.keys(state.files).forEach(filename => {
                zip.file(filename, state.files[filename].content);
            });
            
            const content = await zip.generateAsync({type: 'blob'});
            saveAs(content, 'project.zip');
        }

        // Import project from ZIP
        async function importProject(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const zip = new JSZip();
            const contents = await zip.loadAsync(file);
            
            state.files = {};
            
            for (const filename of Object.keys(contents.files)) {
                if (contents.files[filename].dir) continue;
                
                const content = await contents.files[filename].async('text');
                const extension = filename.split('.').pop().toLowerCase();
                let type = 'plaintext';
                
                if (extension === 'html') type = 'html';
                else if (extension === 'css') type = 'css';
                else if (extension === 'js') type = 'javascript';
                else if (extension === 'py') type = 'python';
                else if (extension === 'json') type = 'json';
                
                state.files[filename] = {
                    content: content,
                    type: type
                };
            }
            
            saveToLocalStorage();
            updateFileTree();
            
            const firstFile = Object.keys(state.files)[0];
            if (firstFile) switchToFile(firstFile);
            
            // Reset the input
            event.target.value = '';
        }

        // Save to localStorage
        function saveToLocalStorage() {
            localStorage.setItem('webIDEState', JSON.stringify({
                files: state.files,
                currentFile: state.currentFile
            }));
        }

        // Load from localStorage
        function loadFromLocalStorage() {
            const saved = localStorage.getItem('webIDEState');
            if (saved) {
                const data = JSON.parse(saved);
                state.files = data.files || {};
                state.currentFile = data.currentFile;
                
                if (state.currentFile && state.files[state.currentFile]) {
                    switchToFile(state.currentFile);
                }
            }
        }

        // Initialize resizable panels
        function initializeResizers() {
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            const rightPanel = document.querySelector('.right-panel');
            const previewPanel = document.querySelector('.preview-panel');
            const consolePanel = document.querySelector('.console-panel');
            
            // Sidebar resizer
            const sidebarResizer = document.getElementById('sidebarResizer');
            let isSidebarResizing = false;
            
            sidebarResizer.addEventListener('mousedown', (e) => {
                isSidebarResizing = true;
                document.addEventListener('mousemove', resizeSidebar);
                document.addEventListener('mouseup', stopResize);
            });
            
            function resizeSidebar(e) {
                if (!isSidebarResizing) return;
                const containerRect = document.querySelector('.container').getBoundingClientRect();
                const width = Math.min(Math.max(e.clientX - containerRect.left, 150), 400);
                sidebar.style.width = width + 'px';
            }
            
            // Main content resizer
            const mainResizer = document.getElementById('mainResizer');
            let isMainResizing = false;
            
            mainResizer.addEventListener('mousedown', (e) => {
                isMainResizing = true;
                document.addEventListener('mousemove', resizeMain);
                document.addEventListener('mouseup', stopResize);
            });
            
            function resizeMain(e) {
                if (!isMainResizing) return;
                const containerRect = document.querySelector('.container').getBoundingClientRect();
                const width = Math.min(Math.max(e.clientX - containerRect.left - sidebar.offsetWidth, 300), containerRect.width - 300);
                rightPanel.style.width = (containerRect.width - width - sidebar.offsetWidth - 10) + 'px';
            }
            
            // Preview resizer
            const previewResizer = document.getElementById('previewResizer');
            let isPreviewResizing = false;
            
            previewResizer.addEventListener('mousedown', (e) => {
                isPreviewResizing = true;
                document.addEventListener('mousemove', resizePreview);
                document.addEventListener('mouseup', stopResize);
            });
            
            function resizePreview(e) {
                if (!isPreviewResizing) return;
                const rightPanelRect = rightPanel.getBoundingClientRect();
                const height = Math.min(Math.max(e.clientY - rightPanelRect.top, 100), rightPanelRect.height - 100);
                previewPanel.style.flex = `0 0 ${height}px`;
            }
            
            function stopResize() {
                isSidebarResizing = false;
                isMainResizing = false;
                isPreviewResizing = false;
                document.removeEventListener('mousemove', resizeSidebar);
                document.removeEventListener('mousemove', resizeMain);
                document.removeEventListener('mousemove', resizePreview);
            }
        }
    </script>
</body>
</html>
