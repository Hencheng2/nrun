<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web IDE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/dracula.min.css">
    <style>
        :root {
            --bg-primary: #1e1e1e;
            --bg-secondary: #252526;
            --bg-tertiary: #2d2d30;
            --text-primary: #cccccc;
            --text-secondary: #969696;
            --accent-blue: #007acc;
            --accent-green: #4ec9b0;
            --accent-orange: #ce9178;
            --accent-purple: #c586c0;
            --border-color: #3e3e42;
            --error-red: #f44747;
            --dark-green: #006400;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
            flex-direction: column;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background-color: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 15px;
            font-weight: bold;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-tree {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }

        .file-item {
            padding: 5px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .file-item:hover {
            background-color: var(--bg-tertiary);
        }

        .file-item.active {
            background-color: var(--accent-blue);
            color: white;
        }

        .file-item-content {
            display: flex;
            align-items: center;
            gap: 5px;
            flex: 1;
        }

        .file-delete {
            color: var(--error-red);
            cursor: pointer;
            padding: 2px 5px;
            border-radius: 3px;
            display: none;
        }

        .file-item:hover .file-delete {
            display: block;
        }

        .file-actions {
            padding: 10px 15px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            border-top: 1px solid var(--border-color);
        }

        .btn {
            background-color: var(--accent-blue);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 3px;
            cursor: pointer;
            text-align: center;
            font-size: 13px;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn.back-btn {
            background-color: var(--dark-green);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .editor-container {
            flex: 1;
            position: relative;
        }

        #editor {
            width: 100%;
            height: 100%;
        }

        /* Right Panel */
        .right-panel {
            width: 50%;
            display: flex;
            flex-direction: column;
            border-left: 1px solid var(--border-color);
        }

        .panel {
            position: relative;
            overflow: hidden;
        }

        .preview-panel {
            flex: 1;
            border-bottom: 1px solid var(--border-color);
        }

        .console-panel {
            height: 30%;
        }

        .panel-header {
            padding: 8px 15px;
            background-color: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-content {
            height: calc(100% - 36px);
            overflow: auto;
        }

        #preview {
            width: 100%;
            height: 100%;
            border: none;
            background-color: white;
        }

        #console {
            padding: 10px;
            font-family: monospace;
            white-space: pre-wrap;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            height: 100%;
            overflow: auto;
        }

        /* Resizable panels */
        .resizer {
            background-color: var(--border-color);
            cursor: col-resize;
            width: 5px;
        }

        .resizer-horizontal {
            background-color: var(--border-color);
            cursor: row-resize;
            height: 5px;
        }

        /* Top bar */
        .top-bar {
            padding: 10px 15px;
            background-color: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .top-bar-left, .top-bar-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .run-btn {
            background-color: var(--accent-green);
            color: black;
            font-weight: bold;
        }

        /* File icons */
        .file-icon {
            width: 16px;
            height: 16px;
            display: inline-block;
            margin-right: 5px;
            background-size: contain;
            background-repeat: no-repeat;
            border-radius: 2px;
        }

        .html-file { background-color: #e44d26; }
        .css-file { background-color: #264de4; }
        .js-file { background-color: #f7df1e; }
        .py-file { background-color: #3776ab; }
        .txt-file { background-color: #888; }
        .json-file { background-color: #f5de19; color: #000; text-align: center; font-weight: bold; }
        .folder-icon { background-color: #7ebae4; }

        /* Hidden file input */
        #fileInput {
            display: none;
        }

        /* Modal for new file creation */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--bg-secondary);
            padding: 20px;
            border-radius: 5px;
            width: 400px;
            max-width: 90%;
        }

        .modal-header {
            margin-bottom: 15px;
            font-weight: bold;
            font-size: 18px;
        }

        .modal-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }

        .modal-option {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
        }

        .modal-option:hover {
            background-color: var(--bg-tertiary);
        }

        .modal-option.selected {
            border-color: var(--accent-blue);
            background-color: rgba(0, 122, 204, 0.2);
        }

        .modal-input {
            width: 100%;
            padding: 8px;
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Loading indicator */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* CodeMirror customizations */
        .CodeMirror {
            height: 100%;
            font-size: 14px;
            line-height: 1.5;
        }

        /* Context menu */
        .context-menu {
            position: absolute;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            z-index: 1000;
            padding: 5px 0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .context-menu-item {
            padding: 8px 15px;
            cursor: pointer;
        }

        .context-menu-item:hover {
            background-color: var(--bg-tertiary);
        }

        /* Responsive design */
        @media (max-width: 1200px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 200px;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }
            
            .resizer {
                display: none;
            }
            
            .right-panel {
                width: 100%;
                height: 50vh;
                border-left: none;
                border-top: 1px solid var(--border-color);
            }
            
            .main-content {
                height: calc(100vh - 200px - 50vh - 50px);
            }
        }

        @media (max-width: 768px) {
            .top-bar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .top-bar-left, .top-bar-right {
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .sidebar {
                height: 150px;
            }
            
            .right-panel {
                height: 40vh;
            }
            
            .main-content {
                height: calc(100vh - 150px - 40vh - 90px);
            }
            
            .file-actions {
                flex-direction: row;
                justify-content: center;
            }
            
            .modal-content {
                width: 95%;
            }
        }

        @media (max-width: 480px) {
            .sidebar {
                height: 120px;
            }
            
            .right-panel {
                height: 35vh;
            }
            
            .main-content {
                height: calc(100vh - 120px - 35vh - 110px);
            }
            
            .btn {
                padding: 6px 8px;
                font-size: 12px;
            }
            
            .top-bar {
                padding: 5px 10px;
            }
        }

        .main-editor-area {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Top Bar with Back Button -->
        <div class="top-bar">
            <div class="top-bar-left">
                <a href="https://hencheng2.github.io/all/" class="btn back-btn">Home</a>
                <button class="btn run-btn" id="runBtn">Run</button>
            </div>
            <div class="top-bar-right">
                <button class="btn" id="exportBtn">Export Project</button>
                <button class="btn" id="importBtn">Import Project</button>
            </div>
        </div>

        <!-- Main Editor Area -->
        <div class="main-editor-area">
            <!-- Sidebar -->
            <div class="sidebar">
                <div class="sidebar-header">
                    <span>EXPLORER</span>
                </div>
                <div class="file-tree" id="fileTree">
                    <!-- Files will be populated here -->
                </div>
                <div class="file-actions">
                    <button class="btn" id="newFileBtn">New File</button>
                    <button class="btn" id="uploadFileBtn">Upload File</button>
                    <input type="file" id="fileInput" multiple>
                </div>
            </div>

            <div class="resizer" id="sidebarResizer"></div>

            <!-- Main Content -->
            <div class="main-content">
                <div class="editor-container">
                    <div id="editor"></div>
                </div>
            </div>

            <div class="resizer" id="mainResizer"></div>

            <!-- Right Panel -->
            <div class="right-panel">
                <div class="panel preview-panel">
                    <div class="panel-header">
                        <span>Preview</span>
                    </div>
                    <div class="panel-content">
                        <iframe id="preview"></iframe>
                    </div>
                </div>
                <div class="resizer-horizontal" id="previewResizer"></div>
                <div class="panel console-panel">
                    <div class="panel-header">
                        <span>Console</span>
                        <button class="btn" id="clearConsoleBtn">Clear</button>
                    </div>
                    <div class="panel-content">
                        <pre id="console"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New File Modal -->
    <div class="modal" id="newFileModal">
        <div class="modal-content">
            <div class="modal-header">Create New File</div>
            <div class="modal-options" id="fileOptions">
                <div class="modal-option selected" data-type="html" data-name="index.html">
                    <strong>HTML File</strong> (index.html) - Web page structure
                </div>
                <div class="modal-option" data-type="css" data-name="style.css">
                    <strong>CSS File</strong> (style.css) - Web page styling
                </div>
                <div class="modal-option" data-type="javascript" data-name="script.js">
                    <strong>JavaScript File</strong> (script.js) - Client-side logic
                </div>
                <div class="modal-option" data-type="python" data-name="main.py">
                    <strong>Python File</strong> (main.py) - Server-side logic
                </div>
                <div class="modal-option" data-type="plaintext" data-name="requirements.txt">
                    <strong>Requirements File</strong> (requirements.txt) - Python dependencies
                </div>
            </div>
            <input type="text" class="modal-input" id="fileNameInput" value="index.html" placeholder="File name">
            <div class="modal-buttons">
                <button class="btn" id="modalCancelBtn">Cancel</button>
                <button class="btn" id="modalCreateBtn">Create</button>
            </div>
        </div>
    </div>

    <!-- Load CodeMirror and JSZip from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/clike/clike.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <!-- Load Pyodide for Python execution -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>

    <script>
        // Global state
        const state = {
            files: {},
            currentFile: null,
            editor: null,
            pyodide: null
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', async function() {
            await initializePyodide();
            initializeEditor();
            initializeResizers();
            loadFromLocalStorage();
            setupEventListeners();
            updateFileTree();
            
            // Create default files if none exist
            if (Object.keys(state.files).length === 0) {
                createFile('index.html', 'html', `<!DOCTYPE html>
<html>
<head>
    <title>My Web App</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>Welcome to My Web App</h1>
    <p>This is a sample web application.</p>
    <button id="clickBtn">Click Me!</button>
    
    <script src="script.js"><\/script>
</body>
</html>`);
                
                createFile('style.css', 'css', `body {
    font-family: Arial, sans-serif;
    margin: 40px;
    background: #f0f0f0;
    line-height: 1.6;
}

h1 {
    color: #333;
}

button {
    background-color: #4CAF50;
    border: none;
    color: white;
    padding: 10px 20px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-size: 16px;
    margin: 4px 2px;
    cursor: pointer;
    border-radius: 4px;
}`);
                
                createFile('script.js', 'javascript', `document.addEventListener('DOMContentLoaded', function() {
    const button = document.getElementById('clickBtn');
    
    button.addEventListener('click', function() {
        alert('Button clicked! This is JavaScript in action.');
        console.log('Button was clicked');
    });
    
    console.log('JavaScript loaded successfully');
});`);
                
                createFile('main.py', 'python', `# Simple Python backend example
def main():
    print("Hello from Python backend!")
    return "Python executed successfully"

if __name__ == "__main__":
    result = main()
    print(result)`);
                
                createFile('requirements.txt', 'plaintext', `# Add Python packages here
# numpy==1.24.3
# requests==2.31.0`);
                
                switchToFile('index.html');
            }
        });

        // Initialize Pyodide for Python execution
        async function initializePyodide() {
            logToConsole('Loading Pyodide...');
            state.pyodide = await loadPyodide();
            
            // Set up Pyodide to capture stdout and stderr
            state.pyodide.runPython(`
                import sys
                import js
                
                class OutputCapture:
                    def __init__(self, is_error=False):
                        self.is_error = is_error
                        
                    def write(self, data):
                        if data.strip():
                            js.logToConsole(data, self.is_error)
                            
                    def flush(self):
                        pass
                
                sys.stdout = OutputCapture()
                sys.stderr = OutputCapture(True)
            `);
            
            logToConsole('Pyodide loaded successfully!');
        }

        // Initialize CodeMirror Editor
        function initializeEditor() {
            const editorElement = document.getElementById('editor');
            
            // Create CodeMirror instance
            state.editor = CodeMirror(editorElement, {
                mode: 'htmlmixed',
                theme: 'dracula',
                lineNumbers: true,
                indentUnit: 4,
                indentWithTabs: false,
                lineWrapping: true,
                autoCloseBrackets: true,
                matchBrackets: true,
                value: ''
            });
            
            // Add change listener for autosave
            state.editor.on('change', () => {
                if (state.currentFile) {
                    state.files[state.currentFile].content = state.editor.getValue();
                    saveToLocalStorage();
                    updatePreview();
                }
            });
        }

        // Set up event listeners
        function setupEventListeners() {
            document.getElementById('newFileBtn').addEventListener('click', showNewFileModal);
            document.getElementById('uploadFileBtn').addEventListener('click', () => document.getElementById('fileInput').click());
            document.getElementById('fileInput').addEventListener('change', handleFileUpload);
            document.getElementById('runBtn').addEventListener('click', runProject);
            document.getElementById('exportBtn').addEventListener('click', exportProject);
            document.getElementById('importBtn').addEventListener('click', () => document.getElementById('fileInput').click());
            document.getElementById('clearConsoleBtn').addEventListener('click', () => document.getElementById('console').textContent = '');
            
            // Modal event listeners
            document.getElementById('modalCancelBtn').addEventListener('click', hideNewFileModal);
            document.getElementById('modalCreateBtn').addEventListener('click', createFileFromModal);
            
            // File option selection
            const options = document.querySelectorAll('.modal-option');
            options.forEach(option => {
                option.addEventListener('click', () => {
                    options.forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                    document.getElementById('fileNameInput').value = option.getAttribute('data-name');
                });
            });
            
            // Context menu for files
            document.getElementById('fileTree').addEventListener('contextmenu', handleContextMenu);
            document.addEventListener('click', () => {
                const contextMenu = document.querySelector('.context-menu');
                if (contextMenu) contextMenu.remove();
            });
        }

        // Show new file modal
        function showNewFileModal() {
            document.getElementById('newFileModal').style.display = 'flex';
        }

        // Hide new file modal
        function hideNewFileModal() {
            document.getElementById('newFileModal').style.display = 'none';
        }

        // Create file from modal selection
        function createFileFromModal() {
            const selectedOption = document.querySelector('.modal-option.selected');
            const type = selectedOption.getAttribute('data-type');
            let name = document.getElementById('fileNameInput').value.trim();
            
            if (!name) {
                alert('Please enter a file name');
                return;
            }
            
            // Add extension if missing
            if (!name.includes('.')) {
                const ext = selectedOption.getAttribute('data-name').split('.').pop();
                name = `${name}.${ext}`;
            }
            
            // Default content based on file type
            let content = '';
            switch(type) {
                case 'html':
                    content = `<!DOCTYPE html>
<html>
<head>
    <title>New Page</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>Hello World</h1>
    <p>Start coding your HTML here</p>
    
    <script src="script.js"><\/script>
</body>
</html>`;
                    break;
                case 'css':
                    content = `/* CSS Styles */
body {
    font-family: Arial, sans-serif;
    line-height: 1.6;
    margin: 0;
    padding: 20px;
    background-color: #f4f4f4;
}

.container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}`;
                    break;
                case 'javascript':
                    content = `// JavaScript code
console.log('Hello from JavaScript!');

document.addEventListener('DOMContentLoaded', function() {
    // Your code here
    console.log('DOM fully loaded and parsed');
});`;
                    break;
                case 'python':
                    content = `# Python code
def main():
    print("Hello from Python!")
    return "Success"

if __name__ == "__main__":
    result = main()
    print(result)`;
                    break;
                case 'plaintext':
                    content = `# Add your Python dependencies here
# One package per line
# Example:
# numpy==1.24.3
# requests==2.31.0`;
                    break;
            }
            
            const filename = createFile(name, type, content);
            switchToFile(filename);
            hideNewFileModal();
        }

        // Create a new file
        function createFile(name, type, content = '') {
            // Ensure unique filename
            let filename = name;
            let counter = 1;
            while (state.files[filename]) {
                const dotIndex = name.lastIndexOf('.');
                if (dotIndex === -1) {
                    filename = `${name} (${counter})`;
                } else {
                    const base = name.substring(0, dotIndex);
                    const ext = name.substring(dotIndex);
                    filename = `${base} (${counter})${ext}`;
                }
                counter++;
            }
            
            state.files[filename] = {
                content: content,
                type: type
            };
            
            saveToLocalStorage();
            updateFileTree();
            return filename;
        }

        // Handle file upload
        function handleFileUpload(event) {
            const files = event.target.files;
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const extension = file.name.split('.').pop().toLowerCase();
                    let type = 'plaintext';
                    
                    if (extension === 'html') type = 'html';
                    else if (extension === 'css') type = 'css';
                    else if (extension === 'js') type = 'javascript';
                    else if (extension === 'py') type = 'python';
                    else if (extension === 'json') type = 'json';
                    
                    createFile(file.name, type, e.target.result);
                };
                
                reader.readAsText(file);
            }
            
            // Reset the input
            event.target.value = '';
        }

        // Switch to a file
        function switchToFile(filename) {
            if (!state.files[filename]) return;
            
            state.currentFile = filename;
            const file = state.files[filename];
            
            // Update editor with proper mode
            let mode;
            switch(file.type) {
                case 'html': mode = 'htmlmixed'; break;
                case 'css': mode = 'css'; break;
                case 'javascript': mode = 'javascript'; break;
                case 'python': mode = 'python'; break;
                default: mode = 'text/plain';
            }
            
            state.editor.setOption('mode', mode);
            state.editor.setValue(file.content);
            
            // Update file tree
            updateFileTree();
        }

        // Delete a file
        function deleteFile(filename) {
            if (!confirm(`Are you sure you want to delete ${filename}?`)) return;
            
            delete state.files[filename];
            
            if (state.currentFile === filename) {
                const remainingFiles = Object.keys(state.files);
                if (remainingFiles.length > 0) {
                    switchToFile(remainingFiles[0]);
                } else {
                    state.currentFile = null;
                    state.editor.setValue('');
                }
            }
            
            saveToLocalStorage();
            updateFileTree();
        }

        // Update file tree display
        function updateFileTree() {
            const fileTree = document.getElementById('fileTree');
            fileTree.innerHTML = '';
            
            Object.keys(state.files).sort().forEach(filename => {
                const file = state.files[filename];
                const fileItem = document.createElement('div');
                fileItem.className = `file-item ${state.currentFile === filename ? 'active' : ''}`;
                
                const fileContent = document.createElement('div');
                fileContent.className = 'file-item-content';
                
                const icon = document.createElement('span');
                icon.className = 'file-icon';
                
                if (file.type === 'html') icon.classList.add('html-file');
                else if (file.type === 'css') icon.classList.add('css-file');
                else if (file.type === 'javascript') icon.classList.add('js-file');
                else if (file.type === 'python') icon.classList.add('py-file');
                else if (file.type === 'json') icon.classList.add('json-file');
                else icon.classList.add('txt-file');
                
                const name = document.createTextNode(filename);
                
                fileContent.appendChild(icon);
                fileContent.appendChild(name);
                
                const deleteBtn = document.createElement('span');
                deleteBtn.className = 'file-delete';
                deleteBtn.innerHTML = '×';
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteFile(filename);
                });
                
                fileItem.appendChild(fileContent);
                fileItem.appendChild(deleteBtn);
                
                fileItem.addEventListener('click', () => switchToFile(filename));
                
                fileTree.appendChild(fileItem);
            });
        }

        // Handle context menu for files
        function handleContextMenu(event) {
            const fileItem = event.target.closest('.file-item');
            if (!fileItem) return;
            
            event.preventDefault();
            
            // Remove any existing context menu
            const existingMenu = document.querySelector('.context-menu');
            if (existingMenu) existingMenu.remove();
            
            const filename = fileItem.querySelector('.file-item-content').textContent;
            
            const contextMenu = document.createElement('div');
            contextMenu.className = 'context-menu';
            contextMenu.style.top = `${event.pageY}px`;
            contextMenu.style.left = `${event.pageX}px`;
            
            const deleteOption = document.createElement('div');
            deleteOption.className = 'context-menu-item';
            deleteOption.textContent = 'Delete';
            deleteOption.addEventListener('click', () => deleteFile(filename));
            
            contextMenu.appendChild(deleteOption);
            document.body.appendChild(contextMenu);
        }

        // Run the project
        async function runProject() {
            // Clear console
            document.getElementById('console').textContent = '';
            
            // Update preview
            updatePreview();
            
            // Run Python files
            await runPythonFiles();
        }

        // Update the preview iframe
        function updatePreview() {
            const preview = document.getElementById('preview');
            let html = '', css = '', js = '';
            
            // Gather HTML, CSS, and JS files
            Object.keys(state.files).forEach(filename => {
                const file = state.files[filename];
                if (file.type === 'html') html += file.content;
                else if (file.type === 'css') css += file.content;
                else if (file.type === 'javascript') js += file.content;
            });
            
            // Create a complete HTML document
            const fullHtml = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <style>${css}</style>
                </head>
                <body>
                    ${html}
                    <script>${js}<\/script>
                </body>
                </html>
            `;
            
            // Update the iframe
            const blob = new Blob([fullHtml], {type: 'text/html'});
            preview.src = URL.createObjectURL(blob);
        }

        // Run Python files with Pyodide
        async function runPythonFiles() {
            let pythonCode = '';
            let hasRequirements = false;
            
            // Gather Python code and check for requirements.txt
            Object.keys(state.files).forEach(filename => {
                const file = state.files[filename];
                if (file.type === 'python') {
                    if (filename === 'requirements.txt') {
                        hasRequirements = true;
                    } else {
                        pythonCode += `# ${filename}\n${file.content}\n\n`;
                    }
                }
            });
            
            if (!pythonCode && !hasRequirements) return;
            
            logToConsole('Running Python code...');
            
            // Execute Python code
            if (pythonCode) {
                try {
                    await state.pyodide.runPythonAsync(pythonCode);
                    logToConsole('Python execution completed.');
                } catch (error) {
                    logToConsole(`Python error: ${error.message}`, true);
                }
            }
            
            // Handle requirements
            if (hasRequirements && state.files['requirements.txt']) {
                const requirements = state.files['requirements.txt'].content.split('\n');
                for (const requirement of requirements) {
                    const packageName = requirement.trim();
                    if (!packageName || packageName.startsWith('#')) continue;
                    
                    logToConsole(`Installing ${packageName}...`);
                    try {
                        await state.pyodide.loadPackage(packageName.split('==')[0]);
                        logToConsole(`✓ Installed ${packageName}`);
                    } catch (error) {
                        logToConsole(`✗ Failed to install ${packageName}: ${error.message}`, true);
                    }
                }
            }
        }

        // Log to console
        function logToConsole(message, isError = false) {
            const consoleElem = document.getElementById('console');
            const line = document.createElement('div');
            
            if (isError) {
                line.style.color = '#f44747';
            }
            
            line.textContent = message;
            consoleElem.appendChild(line);
            consoleElem.scrollTop = consoleElem.scrollHeight;
        }

        // Export project as ZIP
        async function exportProject() {
            logToConsole('Exporting project as ZIP file...');
            
            try {
                const zip = new JSZip();
                
                // Add all files to the ZIP
                for (const filename in state.files) {
                    zip.file(filename, state.files[filename].content);
                }
                
                // Generate the ZIP file
                const content = await zip.generateAsync({type: 'blob'});
                
                // Create download link
                const a = document.createElement('a');
                a.href = URL.createObjectURL(content);
                a.download = 'webide-project.zip';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                logToConsole('Project exported successfully!');
            } catch (error) {
                logToConsole(`Export failed: ${error.message}`, true);
            }
        }

        // Import project from ZIP
        function importProject(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const zip = new JSZip();
                    const contents = await zip.loadAsync(e.target.result);
                    
                    // Clear current files
                    state.files = {};
                    
                    // Extract files from ZIP
                    const filePromises = [];
                    contents.forEach((relativePath, zipEntry) => {
                        if (!zipEntry.dir) {
                            filePromises.push(
                                zipEntry.async('text').then(content => {
                                    const extension = relativePath.split('.').pop().toLowerCase();
                                    let type = 'plaintext';
                                    
                                    if (extension === 'html') type = 'html';
                                    else if (extension === 'css') type = 'css';
                                    else if (extension === 'js') type = 'javascript';
                                    else if (extension === 'py') type = 'python';
                                    else if (extension === 'json') type = 'json';
                                    
                                    state.files[relativePath] = {
                                        content: content,
                                        type: type
                                    };
                                })
                            );
                        }
                    });
                    
                    await Promise.all(filePromises);
                    
                    // Update UI
                    saveToLocalStorage();
                    updateFileTree();
                    
                    if (Object.keys(state.files).length > 0) {
                        switchToFile(Object.keys(state.files)[0]);
                    }
                    
                    logToConsole('Project imported successfully!');
                } catch (error) {
                    logToConsole(`Import failed: ${error.message}`, true);
                }
            };
            
            reader.readAsArrayBuffer(file);
            
            // Reset the input
            event.target.value = '';
        }

        // Save to localStorage
        function saveToLocalStorage() {
            localStorage.setItem('webide-files', JSON.stringify(state.files));
            localStorage.setItem('webide-current', state.currentFile);
        }

        // Load from localStorage
        function loadFromLocalStorage() {
            const files = localStorage.getItem('webide-files');
            const current = localStorage.getItem('webide-current');
            
            if (files) {
                state.files = JSON.parse(files);
            }
            
            if (current && state.files[current]) {
                switchToFile(current);
            } else if (Object.keys(state.files).length > 0) {
                switchToFile(Object.keys(state.files)[0]);
            }
        }

        // Initialize resizers for panels
        function initializeResizers() {
            const sidebarResizer = document.getElementById('sidebarResizer');
            const mainResizer = document.getElementById('mainResizer');
            const previewResizer = document.getElementById('previewResizer');
            
            // Sidebar resizer
            let isSidebarResizing = false;
            sidebarResizer.addEventListener('mousedown', (e) => {
                isSidebarResizing = true;
                document.body.style.cursor = 'col-resize';
                e.preventDefault();
            });
            
            // Main resizer
            let isMainResizing = false;
            mainResizer.addEventListener('mousedown', (e) => {
                isMainResizing = true;
                document.body.style.cursor = 'col-resize';
                e.preventDefault();
            });
            
            // Preview resizer
            let isPreviewResizing = false;
            previewResizer.addEventListener('mousedown', (e) => {
                isPreviewResizing = true;
                document.body.style.cursor = 'row-resize';
                e.preventDefault();
            });
            
            // Mouse move handler
            document.addEventListener('mousemove', (e) => {
                if (isSidebarResizing) {
                    const container = document.querySelector('.container');
                    const sidebar = document.querySelector('.sidebar');
                    const mainEditorArea = document.querySelector('.main-editor-area');
                    
                    const newWidth = e.clientX;
                    if (newWidth > 150 && newWidth < container.clientWidth * 0.5) {
                        sidebar.style.width = `${newWidth}px`;
                        mainEditorArea.style.width = `calc(100% - ${newWidth}px)`;
                    }
                }
                
                if (isMainResizing) {
                    const mainEditorArea = document.querySelector('.main-editor-area');
                    const mainContent = document.querySelector('.main-content');
                    const rightPanel = document.querySelector('.right-panel');
                    
                    const newWidth = mainEditorArea.clientWidth - e.clientX;
                    if (newWidth > 200 && newWidth < mainEditorArea.clientWidth * 0.7) {
                        rightPanel.style.width = `${newWidth}px`;
                        mainContent.style.width = `calc(100% - ${newWidth}px)`;
                    }
                }
                
                if (isPreviewResizing) {
                    const rightPanel = document.querySelector('.right-panel');
                    const previewPanel = document.querySelector('.preview-panel');
                    const consolePanel = document.querySelector('.console-panel');
                    
                    const newHeight = rightPanel.clientHeight - e.clientY;
                    if (newHeight > 100 && newHeight < rightPanel.clientHeight * 0.7) {
                        previewPanel.style.height = `${newHeight}px`;
                        consolePanel.style.height = `calc(100% - ${newHeight}px)`;
                    }
                }
            });
            
            // Mouse up handler
            document.addEventListener('mouseup', () => {
                isSidebarResizing = false;
                isMainResizing = false;
                isPreviewResizing = false;
                document.body.style.cursor = 'default';
            });
        }
    </script>
</body>
</html>
