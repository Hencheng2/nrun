<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code IDE Tool</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.5.0/css/xterm.css" />
    <style>
        body { background-color: #1e1e1e; color: #d4d4d4; }
        #editor { height: 600px; border: 1px solid #333; }
        #output { height: 400px; background: #000; border: 1px solid #333; }
        .list-group-item { cursor: pointer; }
    </style>
    <script src="https://unpkg.com/monaco-editor@latest/min/vs/loader.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.28.2/full/pyodide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.5.0/lib/xterm.js"></script>
</head>
<body class="bg-dark text-light">
    <div class="container mt-4">
        <h1 class="text-center mb-4">Modern Code IDE</h1>
        <div class="row">
            <div class="col-md-3">
                <h5>Project Files</h5>
                <div id="files" class="list-group mb-3"></div>
                <button id="addFile" class="btn btn-primary mb-2">Add File</button>
                <button id="upload" class="btn btn-secondary mb-2">Upload File</button>
                <input type="file" id="fileInput" style="display:none;">
            </div>
            <div class="col-md-9">
                <div id="editor"></div>
                <button id="run" class="btn btn-success mt-2 mb-2">Run</button>
                <div id="output"></div>
            </div>
        </div>
    </div>

    <script>
        // Monaco Editor Setup
        require.config({ paths: { 'vs': 'https://unpkg.com/monaco-editor@latest/min/vs' } });
        window.MonacoEnvironment = { getWorkerUrl: () => proxy };
        let proxy = URL.createObjectURL(new Blob([`
            self.MonacoEnvironment = {
                baseUrl: 'https://unpkg.com/monaco-editor@latest/min/'
            };
            importScripts('https://unpkg.com/monaco-editor@latest/min/vs/base/worker/workerMain.js');
        `], { type: 'text/javascript' }));
        require(["vs/editor/editor.main"], function () {
            window.editor = monaco.editor.create(document.getElementById('editor'), {
                value: '',
                language: 'plaintext',
                theme: 'vs-dark',
                automaticLayout: true
            });
        });

        // Project State
        let project = JSON.parse(localStorage.getItem('project')) || { files: [] };
        let currentIndex = -1;
        let pyodide = null;
        let terminal = new Terminal({ theme: { background: '#000', foreground: '#0f0' } });

        function saveProject() {
            localStorage.setItem('project', JSON.stringify(project));
        }

        function renderFiles() {
            const filesDiv = document.getElementById('files');
            filesDiv.innerHTML = '';
            project.files.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'list-group-item list-group-item-dark';
                item.textContent = file.name;
                item.onclick = () => loadFile(index);
                filesDiv.appendChild(item);
            });
        }

        function loadFile(index) {
            currentIndex = index;
            editor.setValue(project.files[index].content);
            monaco.editor.setModelLanguage(editor.getModel(), getMonacoLanguage(project.files[index].lang));
        }

        function getMonacoLanguage(lang) {
            if (lang === 'py') return 'python';
            if (lang === 'js') return 'javascript';
            if (lang === 'css') return 'css';
            if (lang === 'html') return 'html';
            return 'plaintext';
        }

        function getBoilerplate(lang) {
            if (lang === 'html') return '<!DOCTYPE html>\n<html>\n<head>\n<title></title>\n</head>\n<body>\n</body>\n</html>';
            if (lang === 'css') return 'body {\n  background-color: #fff;\n}';
            if (lang === 'js') return 'console.log("Hello World");';
            if (lang === 'py') return 'print("Hello World")';
            if (lang === 'txt') return '';
            return '';
        }

        // Add File
        document.getElementById('addFile').onclick = () => {
            const name = prompt('Enter file name (e.g., example.html)');
            if (name) {
                const lang = name.split('.').pop().toLowerCase();
                const content = getBoilerplate(lang);
                project.files.push({ name, lang, content });
                saveProject();
                renderFiles();
                loadFile(project.files.length - 1);
            }
        };

        // Upload File
        const fileInput = document.getElementById('fileInput');
        document.getElementById('upload').onclick = () => fileInput.click();
        fileInput.onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                const name = file.name;
                const lang = name.split('.').pop().toLowerCase();
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const content = ev.target.result;
                    project.files.push({ name, lang, content });
                    saveProject();
                    renderFiles();
                    loadFile(project.files.length - 1);
                };
                reader.readAsText(file);
            }
        };

        // Run Button
        document.getElementById('run').onclick = async () => {
            if (currentIndex === -1) return alert('Select a file');
            const file = project.files[currentIndex];
            const outputDiv = document.getElementById('output');
            outputDiv.innerHTML = '';
            terminal.reset();
            terminal.open(outputDiv);

            if (file.lang === 'py') {
                terminal.write('Initializing Python...\r\n');
                if (!pyodide) pyodide = await loadPyodide();
                // Install from requirements.txt if exists
                const reqFile = project.files.find(f => f.name === 'requirements.txt');
                if (reqFile) {
                    terminal.write('Installing packages...\r\n');
                    const packages = reqFile.content.split('\n').filter(l => l.trim() && !l.startsWith('#'));
                    for (let p of packages) {
                        await pyodide.runPythonAsync(`import micropip\nawait micropip.install('${p.trim()}')`);
                        terminal.write(`Installed ${p.trim()}\r\n`);
                    }
                }
                // Run code
                terminal.write('Running Python code...\r\n');
                try {
                    const result = await pyodide.runPythonAsync(editor.getValue());
                    terminal.write((result || 'Done') + '\r\n');
                } catch (err) {
                    terminal.write(err + '\r\n');
                }
            } else {
                // Web mode: Combine HTML, CSS, JS
                let htmlContent = '';
                let cssContent = '';
                let jsContent = '';
                project.files.forEach(f => {
                    if (f.lang === 'html') htmlContent = f.content;
                    if (f.lang === 'css') cssContent = `<style>${f.content}</style>`;
                    if (f.lang === 'js') jsContent = `<script>${f.content}<\/script>`;
                });
                if (!htmlContent) htmlContent = editor.getValue(); // Fallback to current if no html
                const srcdoc = `<html><head>${cssContent}</head><body>${htmlContent}${jsContent}</body></html>`;
                outputDiv.innerHTML = `<iframe srcdoc="${srcdoc.replace(/"/g, '&quot;')}" style="width:100%;height:100%;border:none;"></iframe>`;
            }
        };

        // Initial Render
        renderFiles();
        if (project.files.length > 0) loadFile(0);
    </script>
</body>
</html>
